openapi: 3.0.0
# Added by API Auto Mocking Plugin
servers: []
info:
  description: "The PDS is the main interface to the PDS application for providing clinical decision support for end users. The PDS is a highly fault-tolerant system, meaning that it will attempt to correct errors in order to keep running and avoid catastrophic failure. This means that these endpoints will attempt to return some kind of meaningful data along with 4xx (Client Error) and 5xx (Server Error) status codes. The onus is on the client to check and determine how to render the data returned along with these codes." 
  version: "5"
  title: "PDS plugin: primary platform interface"
  contact:
    email: txscience@lists.renci.org
paths:
  /patientVariables:
    post:
      summary: "Return patient variables required by a guidance plugin"
      description: "Given a guidance plugin id (piid), mapper, FHIR plugin and patient id (ptid), return all the relevant mapped patient variable values. If no mapper or FHIR server are specified, patient variable values are returned using the system default mapper and FHIR server. If no default is set, 5xx message will warn that defaults were selected arbitrarily and the client should react appropriately. If no timestamp is provided, values will be computed relevant to the current time. Values will be returned with the patient variable 'id'; to validate that value, call the '/config/{<piid>}' endpoint and find 'id' on the list of patient variables in order to get the set of legal values for that patient variable 'id'. The same call will also return why the variable is needed by the plugin. Patient variable values are also returned by the '/guidance' endpoint."
      operationId: api.get_patient_variables
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatientVariablesInputs'
      responses: # has to match output of dispatcher.py
        '200':
          description: "Successful operation"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PatientVariableValue'
                example:  [ 
                  {
                    "id": "LOINC:39156-5",
                    "title": "BMI",
                    "variableValue": {
                      "value": "23",
                      "units": "kg/m^2"
                    },
                    "how": "Computed from height[175 cm] recorded in Observation resource [id] on [2018-11-02T12:40:00.00+00:00] and weight[67 kg] recoreded in Observation resource [id] on [2019-11-02T12:40:00.00+00:00] ",
                    "timestamp": "2019-12-03T13:41:09.942+00:00"
                  }, {
                    "id": "LOINC:30525-0",
                    "title": "Age",
                    "variableValue": {
                      "value": ".5",
                      "units": "years"
                    },
                    "how": "The value was specified by the end user.",
                    "timestamp": "2019-12-03T13:41:09.942+00:00"
                  } ] 
        '400':
          description: "Bad Request"
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages: 
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "Mapper[pdspi-mapper-example] not compatible with FHIR server[pdspi-fhir-hapi]",
                      "source": "admin user",
                      "level": 1,
                      "action": "Use arbitrary FHIR server[pdspi-fhir-example]. Only one FHIR server available that is also compatible with Mapper[pdspi-mapper-example]"
                      } ]
                  values:
                    type: array
                    items:
                      $ref: '#/components/schemas/PatientVariableValue'
        '500':
          description: "Internal Server Error"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "No FHIR server specified and no default FHIR server found",
                      "source": "admin user",
                      "level": 1,
                      "action": "Returning values from arbitrary, compatible FHIR server[pdspi-fhir-example]."
                      } ]
                  values:
                    type: array
                    items:
                      $ref: '#/components/schemas/PatientVariableValue'
  /config:
    get:
      summary: Configuration and default info for plugin(s)
      description: "Gets list of plugins with their selector values, default parameter settings, and required patient variables. Legal values for selectors is optional, and if required, call the '/selectors' endpoint. Legal values for a plugin's parameters and required patient variables, if any, can be found with this call."
      operationId: api.get_config
      parameters:
        - name: piid
          description: "If present, include only information about the indicated plugin. if not present, return all guidance piids and their info."
          example: "pdspi-guidance-example."
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: "Config matching query"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PluginConfig'
                example:
                  [ {
                      "title": "Aminoglycoside dosing guidance",
                      "piid": "pdspi-aminoglycoside-nomogram",
                      "pluginType": "g",
                      "pluginSelectors": [ {
                          "title": "Drug",
                          "id": "dosing.rxCUI",
                          "selectorValue": {
                            "value": "rxCUI:1596450",
                            "title": "Gentamicin" }
                          } ],
                      "pluginParameterDefaults": [ {
                          "id": "pdspi-guidance-example:1",
                          "title": "Extended interval nomogram",
                          "parameterDescription": "This calculator uses one of four extended-interval nomograms. Please choose one nomogram.",
                          "parameterValue": { "value": "Hartford" },
                          "legalValues": {
                            "type": "string",
                            "enum": [ "Hartford", "Urban-Craig", "Conventional A", "Conventional B" ] }
                        } ],
                      "requiredPatientVariables": [ {
                          "id": "LOINC:30525-0",
                          "title": "Age",
                          "legalValues": { "type": "number", "minimum": "0" },
                          "why": "Age is used to calculate the creatinine clearance. Dosing is lower for geriatric patient and contraindicated for pediatric patients"
                        },
                        {
                          "id": "LOINC:39156-5",
                          "title": "BMI",
                          "legalValues": { "type": "number", "minimum": "0" },
                          "why": "BMI is used to calculate the creatinine clearance. Dosing is higher for patients with higher BMI"
                        }]
                    } ]
        '400':
          description: "Bad Request"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: 
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "[<piid>] is not a valid plugin",
                      "source": "client",
                      "level": 4,
                      "action": "Returning all plugins"
                      } ]
                  configs:
                    type: array
                    items:
                      $ref: '#/components/schemas/PluginConfig'
                    example:
                      [ {
                          "title": "Aminoglycoside dosing guidance",
                          "piid": "pdspi-aminoglycoside-nomogram",
                          "pluginType": "g",
                          "pluginSelectors": [ {
                              "title": "Drug",
                              "id": "dosing.rxCUI",
                              "selectorValue": {
                                "value": "rxCUI:1596450",
                                "title": "Gentamicin" }
                              } ],
                          "pluginParameterDefaults": [ {
                              "id": "pdspi-guidance-example:1",
                              "title": "Extended interval nomogram",
                              "parameterDescription": "This calculator uses one of four extended-interval nomograms. Please choose one nomogram.",
                              "parameterValue": { "value": "Hartford" },
                              "legalValues": {
                                "type": "string",
                                "enum": [ "Hartford", "Urban-Craig", "Conventional A", "Conventional B" ] }
                            } ],
                          "requiredPatientVariables": [ {
                              "id": "LOINC:30525-0",
                              "title": "Age",
                              "legalValues": { "type": "number", "minimum": "0" },
                              "why": "Age is used to calculate the creatinine clearance. Dosing is lower for geriatric patient and contraindicated for pediatric patients"
                            },
                            {
                              "id": "LOINC:39156-5",
                              "title": "BMI",
                              "legalValues": { "type": "number", "minimum": "0" },
                              "why": "BMI is used to calculate the creatinine clearance. Dosing is higher for patients with higher BMI"
                            }]
                        } ]
        '500':
          description: "Internal Server Error"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: 
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "No default Mapper and multiple compatible Mappers for FHIR server [pdspi-fhir-example].",
                      "source": "admin user",
                      "level": 1,
                      "action": " Chose arbitrary Mapper[pdspi-mapper-example]"
                      } ]
                  configs:
                    type: array
                    items:
                      $ref: '#/components/schemas/PluginConfig'
                    example:
                      [ {
                          "title": "Aminoglycoside dosing guidance",
                          "piid": "pdspi-aminoglycoside-nomogram",
                          "pluginType": "g",
                          "pluginSelectors": [ {
                              "title": "Drug",
                              "id": "dosing.rxCUI",
                              "selectorValue": {
                                "value": "rxCUI:1596450",
                                "title": "Gentamicin" }
                              } ],
                          "pluginParameterDefaults": [ {
                              "id": "pdspi-guidance-example:1",
                              "title": "Extended interval nomogram",
                              "parameterDescription": "This calculator uses one of four extended-interval nomograms. Please choose one nomogram.",
                              "parameterValue": { "value": "Hartford" },
                              "legalValues": {
                                "type": "string",
                                "enum": [ "Hartford", "Urban-Craig", "Conventional A", "Conventional B" ] }
                            } ],
                          "requiredPatientVariables": [ {
                              "id": "LOINC:30525-0",
                              "title": "Age",
                              "legalValues": { "type": "number", "minimum": "0" },
                              "why": "Age is used to calculate the creatinine clearance. Dosing is lower for geriatric patient and contraindicated for pediatric patients"
                            },
                            {
                              "id": "LOINC:39156-5",
                              "title": "BMI",
                              "legalValues": { "type": "number", "minimum": "0" },
                              "why": "BMI is used to calculate the creatinine clearance. Dosing is higher for patients with higher BMI"
                            }]
                        } ]
  /selectors:
    get:
      summary: List all PDS selectors
      description: List selectors and the legal values that can be used for choosing plugins
      operationId: api.get_selectors
      responses:
        '200':
          description: "List of all selectors used by installed plugins (possibly a subset of all supported selectors)."
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Selector'
                example:
                  [ {"title": "Drug",
                      "id": "dosing.rxCUI",
                      "legalValues": {
                        "type": "string",
                        "enum": [ {"value": "rxCUI:1596450", "title": "Gentamicin"}, {"value": "rxCUI:1114195"}, {"value": "rxCUI:1546356"}, {"value": "rxCUI:1364430"}, {"value": "rxCUI:1599538"}, {"value": "rxCUI:1927851"}
                        ] 
                      }
                    } ]
        '400':
          description: "Bad Request"
          content: 
            application/json:
              schema:
                type: object
                properties:
                  message: 
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "Unknown query paramaters",
                      "source": "client",
                      "level": 4,
                      "action": "Ignoring query parameters"
                      } ]
                  selectors:
                    type: array
                    items:
                      $ref: '#/components/schemas/Selector'
                    example:
                      [ {"title": "Drug",
                          "id": "dosing.rxCUI",
                          "legalValues": {
                            "type": "string",
                            "enum": [ {"value": "rxCUI:1596450", "title": "Gentamicin"}, {"value": "rxCUI:1114195"}, {"value": "rxCUI:1546356"}, {"value": "rxCUI:1364430"}, {"value": "rxCUI:1599538"}, {"value": "rxCUI:1927851"}
                            ] 
                          }
                        } ]
        '500':
          description: "Internal Server Error"
          content: 
            application/json:
              schema:
                type: object
                properties:
                  message: 
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "Guidance plugin[pdspi-guidance-example] not responding after multiple attempts",
                      "source": "pds",
                      "level": 2,
                      "action": "Disabled plugin[pdspi-guidance-example]"
                      } ]
                  selectors:
                    type: array
                    items:
                      $ref: '#/components/schemas/Selector'
                    example: [  ]
  /guidance:
    post:
      summary: Given a patient ID and a plugin id, return the guidance
      operationId: api.get_guidance
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GuidanceInputs'
            example:
              { "piid": "pdspi-guidance-example",
              "ptid": "38",
              "timestamp": "2019-12-03T13:41:09.942+00:00",
              "pluginParameterValues": [ {
                  "id": "pdspi-guidance-example:1",
                  "title": "Extended interval nomogram",
                  "parameterDescription": "This calculator uses one of four extended-interval nomograms. Please choose one nomogram.",
                  "parameterValue": { "value": "Hartford" }
                } ],
              "userSuppliedPatientVariables": [ {
                  "id": "LOINC:30525-0",
                  "title": "Age",
                  "variableValue": {
                    "value": "0.5",
                    "units": "years"
                  },
                  "how": "The value was specified by the end user.",
                  "timestamp": "2019-12-03T13:41:09.942+00:00"
                } ]  }
      responses:
        '200':
          description: "Guidance matching query"
          content: 
            application/json:
              schema:
                  $ref: '#/components/schemas/Guidance'
        '400':
          description: "Bad Request"
          content: 
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "Missing patient variable[LOINC:30525-0]",
                      "source": "pdspi-mapper-example",
                      "level": 3,
                      "action": "Called plugin with missing values [pdspi-guidance-example]"
                      },
                      {
                      "timestamp": "2019-09-20T00:00:02Z",
                      "event": "Missing patient variable[LOINC:30525-0]",
                      "source": "pdspi-guidance-example",
                      "level": 3,
                      "action": "Set LOINC:30525-0='85' for most conservative guidance"
                      }]
                  guidance:
                    $ref: '#/components/schemas/Guidance'
        '500':
          description: "Internal Server Error"
          content: 
            application/json:
              schema:
                type: object
                properties:
                  message: 
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                    example: [  {
                      "timestamp": "2019-09-20T00:00:01Z",
                      "event": "Guidance plugin results did not pass JSON validator:[{\"valuE\": \"5\"}]",
                      "source": "pdspi-guidance-example",
                      "level": 3,
                      "action": "Correction attempted: 'valuE' to 'value'."
                      }]
                  guidance:
                    $ref: '#/components/schemas/Guidance'
components:
  schemas:
    Message:
      description: "This schema mirrors the 'Log' schema from tx-logging (see github.com/RENCI/tx-logging)."
      type: object
      required:
        - timestamp
        - event
        - source
        - level
      properties:
        -id:
          not: {}
        timestamp:
          type: string
          format: date-time
          example: "2019-09-20T00:00:00Z"
        event:
          type: string
          example: "The specified mapper (pdspi-mapper-example) is not compatible with the specified FHIR server (pdspi-fhir-hapi)."
        source:
          type: string
          example: "admin user"
        level:
          description: "The level value mirrors syslog values, as follows: 1 - alert, 'immediate action is needed' : e.g., the data will be returned, but PDS picked a mapper/server at random because no default was selected; 2 - critical: this could indicate resources are nearing full, or similar; 3 - error: something unexpected happened, PDS tried to correct for it, but the admin should be alerted; 4 - warning: PDS had to correct something unexpectedly but all is well; 5 - notification, 'Normal but significant condition': a dashboard might chose to render this message in a special console box; 6 - informational: same as above, but for auditing; 7 - debugging: maybe the dashboard has an optional debugging console box for handling debug messages."
          type: integer
          enum: [1,2,3,4,5,6,7]
          example: 1
        action:
          type: string
          example: "Arbitrarily chose this FHIR server from those available: (pdspi-fhir-example). Only one FHIR server is available that is also compatible with pdspi-mapper-example"
    PatientVariablesInputs:
      type: object
      required:
        - ptid
        - guidance_piid
      properties:
        ptid:
          description: "The ID of the patient for which patient variable values are required."
          type: string
          example: "38"
        guidance_piid:
          description: "Uniquely identifies an enabled guidance plugin that will determine the subset of required patient variables. This is a required value because the client should only have access to patient variables required by the installed plugins (need-to-know access to patient data)."
          type: string
          example: "pdspi-guidance-example"
        mapper_piid:
          description: "Uniquely identifies an enabled mapper plugin to use for mapping FHIR resources to variables that are relevant to the guidance plugin. If not specified, PDS will use the default mapper."
          type: string
        fhir_piid:
          description: "Uniquely identifies an enabled FHIR server plugin which is compatible with the named mapper plugin. If not specified, the PDS will use the default server."
          type: string
        userSuppliedPatientVariables:
          description: "User-supplied patient values to override EHR values, and/or replace values missing in the EHR. Each item in this array should have the 'how:' value set to 'The value was specified by the end user.'"
          type: array
          items:
            $ref: '#/components/schemas/PatientVariableValue'
          example:   {
              "id": "LOINC:30525-0",
              "title": "Age",
              "variableValue": {
                "value": ".5",
                "units": "years"
              },
              "how": "The value was specified by the end user.",
              "timestamp": "2019-12-03T13:41:09.942+00:00"
            }         
        timestamp:
          description: "If absent, defaults to current time."
          type: string
          format: date-time
    PatientVariableValue:
      type: object
      required:
        - id
        - variableValue
        - certitude
        - how
      properties:
        id:
          type: string
          description: "The id for one of the patient variables supported by this PDS version. If the client does not recognize this id, it should 1) log a warning, 2) not solicit user input for the id, 3) attempt to render the value, and 4) attempt to render the 'how' and 'why' for this unknown variable in the justification section of the client interface, assuming there is one."
          example: "LOINC:30525-0"
        title:
          type: string
          description: "A non-standardized, human-readable string to describe the patient variable indicated by this id. The 'title' may be implemented by the PDS to aid in debugging, and clients should not depend on this value. The client should have prior knowledge of the supported patient variables, and thus should provide it's own human-readable titles for representation on any end-user interfaces in the appropriate language."
          example: "Age"
        variableValue:
          type: string
          description: "The patient variable id maps to only one RequiredPatientVariable, which in turn, defines all the legal values (legalValues) for this id. The legalValues defines the type for the variableValue, and so can be used to inform the client on how to render the variableValue. The client can find the type by calling the '/config' endpoint, matching the 'id' with that in the 'RequiredPatientVariable' schema, and looking up 'legalValues'. The variableValue may also include the 'units' field, which is optional, and if left off, implies the system default units. NOTE: The 'variableValue' is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user."
          example: {"value": "0.5", "units": "years"}
        how:
          type: string
          description: "A value such as 'The value was specified by the end user.' indicates that any value in the EHR has been overriden by the client via the input values to the endpoint, and they will be simply passed back here."
          example: "The value was specified by the end user."
        certitude:
          type: integer
          description: The certitude of the value, 0 not certain, 1 somewhat certain, 2 certain
          example: 2
        timestamp:
          description: "If absent, defaults to current time."
          type: string
          format: date-time
          example: "2019-12-03T13:41:09.942+00:00"
    PluginConfig:
      type: object
      required:
        - piid
        - pluginType
        - requiredPatientVariables
      properties:
        title:
          type: string
          description: "Meaningful name for this plugin"
          example: "Aminoglycoside dosing guidance"
        piid:
          type: string
          description: "A string, unique to this deployment, used to identify this plugin in realtime"
          example: "pdspi-aminoglycoside-nomogram"
        pluginType:
          type: string
          enum: [e,g,m,mD,f,fD]
          description: "A value from the enumeration below identifying the plugin type. 'g'=Guidance, 'c'=convenience, 'm'=mapper, 'f'=FHIR data server, 'mD'= default mapper, 'fD'=default FHIR server. In the clinical arena, only one FHIR server and only one mapper is allowed, and this can be indicated either with the defaults, or by only installing one mapper and one FHIR plugin type."
          example: "g"
        pluginTypeTitle:
          type: string
          description: "A human-readable value for the type. 'g'=Guidance, 'c'=Convenience, 'm'=Mapping, 'f'=FHIR, 'mD'=Default Mapping plugin, 'fD'=Default FHIR plugin"
        pluginDependencies:
          type: array
          items:
            type: string
            description: "An array of container names upon which the plugin in question depends. For example, 'txscience/pds-fhir-example:0.2.0'. Mapper plugins must indicate a dependency on one or more FHIR plugins, but dependencies are discouraged otherwise in order to maintain the decoupling and reuse of plugins. Every plugin of type 'm' and 'mD' must have at least one 'f' or 'fD' plugin listed in pluginDependencies, otherwise return 500."
        pluginSelectors:
          description: "Maps the piid to a set of selector values. Optionally call the /selectors endpoint first to get the full list of available selectors and their legal values. For example, two selectors might be 1. drug type and 2. indication. If the client selects values for the selector that matches all piid selector values, then this plugin can provide guidance. Potentially, a decision tree could be implemented here by prefacing each selectorarray item with logic, but for this API version we will instead always AND all the selector array elements. For example, 'if guidance is requried for drug _x_ AND indication _y_ then use plugin _z_'."
          type: array
          items:
            $ref: '#/components/schemas/Selector'
        pluginParameterDefaults:
          description: "Default, typed values for any parameters that might be required by the plugin"
          type: array
          items:
            $ref: '#/components/schemas/PluginParameter'
        requiredPatientVariables:
          type: array
          items:
            $ref: '#/components/schemas/RequiredPatientVariable'
    PluginParameter:
      type: object
      required:
        - id
        - parameterValue
      properties:
        id:
          type: string
          description: "The id for one of the parameters used by the plugin in question. Parameters are completely defined by the plugin and need not be interchangable with other plugins. The client will have no prior knowledge for plugin parameters."
          example: "pdspi-guidance-example:1"
        title: 
          type: string
          description: "A non-standardized, human-readable string to describe the id. May be implemented by the PDS to aid in debugging, clients should not depend on this value."
          example: "Extended interval nomogram"
        parameterDescription:
          type: string
          description: "Description provided by the plugin. The plugin, not the client, is therefore responsible for converting the descriptions to the appropriate language based on internationalization and personalization preferences."
          example: "This calculator uses one of four extended-interval nomograms. Please choose one nomogram."
        parameterValue:
          type: string
          description: "The actual value of the parameter. NOTE: This value is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user."
          example: {"value": "Hartford"}
        legalValues:
          type: string
          description: "The 'legalValues' will always be present in the '/config' endpoint response and need not be provided to or from the client in the '/guidance' endpoint call. Use the JSON schema, https://json-schema.org/draft/2019-09/json-schema-validation.html. For example, { type: 'string', 'enum': [ 'Gentamicin', 'Amikacin' ] } to define an enumeration,  { 'type': 'number' } for a float, and { 'type': 'number', 'minimum': '0' } for a positive number, and { 'type': 'integer' } for an integer. NOTE: This value is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user. "
          example: { "type": "string", "enum": ["Hartford", "Urban-Craig", "Conventional A", "Conventional B"] }
    RequiredPatientVariable:
      type: object
      required:
        - id
        - why
      properties:
        id:
          type: string
          description: "The id for one of the patient variables supported by this PDS version. The client has the option of ignoring this variable if it doesn't recognize the id."
          example: "LOINC:30525-0"
        title:
          type: string
          description: "A non-standardized, human-readable string to describe the id. May be implemented by the PDS to aid in debugging, clients should not depend on this value. NOTE: This value is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user."
          example: "Age"
        legalValues:
          type: string
          description: "If absent, all values are legal, so treat the value like a string. Use the JSON schema, https://json-schema.org/draft/2019-09/json-schema-validation.html. For example, { type: 'string', 'enum': [ 'Gentamicin', 'Amikacin' ] } to define an enumeration,  { 'type': 'number' } for a float, and { 'type': 'number', 'minimum': '0' } for a positive number, and { 'type': 'integer' } for an integer. The client should have prior knowledge of the supported patient variables, and thus should provide it's own human-readable titles for representation on any end-user interfaces in the appropriate language. NOTE: This value is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user. "
          example: { "type": "number", "minimum": "0" }
        why:
          type: string
          description: "Provides the client with a human-readable, non-standard justification for why the plugin needs this particular variable. This can be rendered by the client to provide the end-user with rationale for the patient values, but does not address how the value was computed."
          example: "Age is used to calculate the creatinine clearance. Dosing is lower for geriatric patient and contraindicated for pediatric patients"
    Selector:
      description: "Used for selecting plugins"
      type: object
      required:
        - id
      properties:
        title:
          type: string
          example: "Drug"
          description: "Human-readable name for this selector type."
        id:
          type: string
          description: "The client should have prior knowledge of the full list of selectors available with this version of the PDS. This id is used to determine which selector type is described."
          example: "dosing.rxCUI"
        selectorValue:
          type: string
          description: "Unique identifier for this type. Stylistically, community standard coding system used for this type will preface the code used, e.g., rxCUI:1596450. If no standard exists 'PDS:<id>' will be used. The 'title' property illustrated in the example is optional and might be used by the PDS for debugging purposes. NOTE: This value is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user. "
          example: {"value": "rxCUI:1596450", "title": "Gentamicin"}
        legalValues:
          type: string
          description: "If absent, all values are legal, so treat the value like a string. Use the JSON schema, https://json-schema.org/draft/2019-09/json-schema-validation.html. For example, { type: 'string', 'enum': [ 'Gentamicin', 'Amikacin' ] } to define an enumeration,  { 'type': 'number' } for a float, and { 'type': 'number', 'minimum': '0' } for a positive number, and { 'type': 'integer' } for an integer. Furthermore, a non-standard 'title' can be added in support of a human-readable string for the type's value. This maybe be implemented by the PDS to aid in debugging, however clients should not depend on this value. NOTE: This value is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user."
          example: { "type": "string", "enum": [{"value": "rxCUI:1596450", "title": "Gentamicin"},{"value": "rxCUI:1114195"},{"value": "rxCUI:1546356"},{"value": "rxCUI:1364430"},{"value": "rxCUI:1599538"},{"value": "rxCUI:1927851"}] }
    GuidanceInputs:
      type: object
      required:
        - piid
      properties:
        piid:
          type: string
          example: "pdspi-guidance-example"
          description: "Uniquely identifies the enabled and installed plugin to use for retrieving guidance"
        fhir_piid:
          type: string
          example: "pdspi-fhir-example"
          description: "Uniquely identifies the enabled and installed plugin to use for mapper"
        mapper_piid:
          type: string
          example: "pdspi-mapper-example"
          description: "Uniquely identifies the enabled and installed plugin to use for fhir"
        ptid:
          description: "The ID of the patient for which guidance is required. If not specified, depend only on userSuppliedPatientVariables"
          type: string
          example: "38"
        timestamp:
          description: "If not specified, use current time"
          type: string
          format: date-time
          example: "2019-12-03T13:41:09.942+00:00"
        pluginParameterValues:
          description: "User-supplied parameter values to override plugin defaults"
          type: array
          items:
            $ref: '#/components/schemas/PluginParameter'
        userSuppliedPatientVariables:
          description: "User-supplied patient values to override EHR values, and/or replace values missing in the EHR"
          type: array
          items:
            $ref: '#/components/schemas/PatientVariableValue'
          example:  [ {
              "id": "LOINC:30525-0",
              "title": "Age",
              "variableValue": {
                "value": ".5",
                "units": "years"
              },
              "how": "The value was specified by the end user.",
              "timestamp": "2019-12-03T13:41:09.942+00:00"
            } ]
    Guidance:
      description: "Returns guidance, justification, visualization data and data type, as well as cds-hooks compatible formats for direct integration with the EHR."
      type: object
      required:
        - justification
        - cards
      properties:
        piid:
          description: "A string, unique to this deployment, used to identify this plugin in realtime"
          type: string
          example: "pdspi-aminoglycoside-nomogram"
        title:
          description: "An optional title for the guidance plugin"
          type: string
          example: "Aminoglycoside dosing guidance"
        justification:
          description: "Lists patient variables that were used and how they were computed and why they were needed. Justification informs expert user on whether or not to trust this guidance. Justification is provided both by the guidance plugin, which describes 'why' it needs each patient variable, and by the mapper plugin, which describes 'how' each patient variable was derived."
          type: array
          items:
            type: object
            required:
              - id
              - how
              - why
              - variableValue
            properties:
              id: 
                description: "The id for one of the patient variables supported by this PDS version. If the client does not recognize this id, it should 1) log a warning, 2) not solicit user input for the id, 3) attempt to render the value, and 4) attempt to render the 'how' and 'why' for this unknown variable in the justification section of the client interface, assuming there is one."
                type: string
                example: "LOINC:30525-0"
              title: 
                description: "A non-standardized, human-readable string to describe the patient variable indicated by this id. The 'title' may be implemented by the PDS to aid in debugging, and clients should not depend on this value. The client should have prior knowledge of the supported patient variables, and thus should provide it's own human-readable titles for representation on any end-user interfaces in the appropriate language."
                type: string
                example: "Age"
              how:
                description: "A value such as 'The value was specified by the end user.' indicates that any value in the EHR has been overriden by the client via the input values to the endpoint, and they will be simply passed back here."
                type: string
                example: "The value was specified by the end user."
              why:
                description: "Provides the client with a human-readable, non-standard justification for why the plugin needs this particular variable. This can be rendered by the client to provide the end-user with rationale for the patient values, but does not address how the value was computed."
                type: string
                example: "Age is used to calculate the creatinine clearance. Dosing is lower for geriatric patient and contraindicated for pediatric patients"
              variableValue:
                description: "The justification id maps to only one PatientVariable, which in turn, defines all the legal values (legalValues) for this id. The legalValues define the type for the variableValue, and so can be used to inform the client on how to render the variableValue. The legalValues field here is optional, so the client can find the type by calling the '/config' endpoint, matching the 'id' with that in this justification schema, and looking up 'legalValues'. The variableValue may also include the 'units' field, which is optional, and if left off, implies the system default units. NOTE: The 'variableValue' is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user."
                type: string
                example: {"value": "0.5", "units": "years"}
              legalValues: 
                description: "The 'legalValues' will always be present in the '/config' endpoint response and need not be provided to or from the client in the '/guidance' endpoint call. Use the JSON schema, https://json-schema.org/draft/2019-09/json-schema-validation.html. For example, { type: 'string', 'enum': [ 'Gentamicin', 'Amikacin' ] } to define an enumeration,  { 'type': 'number' } for a float, and { 'type': 'number', 'minimum': '0' } for a positive number, and { 'type': 'integer' } for an integer. NOTE: This value is actually an object type, but we use 'string' here to overcome a shortcoming of the swagger ui. This design choice was made in order to prioritize a better interactive documentation experience for the API user. "
                type: string
                example: {"type": "number", "minimum": "0"}
              timestamp:
                type: string
                format: date-time
                description: "If not specified, assume current time"
        vizOutputs:
          type: array
          items:
            type: object
            properties:
              survival: 
                type: string
                example:
                  "(x,y),..."
              pkpd:
                type: string
                example:
                  "(x,y),..."
        cards:
          type: array
          items:
            $ref: '#/components/schemas/Card'
    Card:
      type: object
      required:
        - id
        - summary
        - indicator
        - source
      properties:
        id: 
          type: string
        title:
          type: string
        summary:
          type: string
          description: "cds-hooks: <140-character summary sentence for display to the user inside of this card"
          example: "some <140 char Summary Message"
        detail:
          type: string
          description: "cds-hooks: - optional detailed information to display (GitHub Flavored Markdown)"
          example: "some sort of optional GitHub Markdown details"
        indicator:
          type: string
          description: " urgency/importance of what this card conveys (info/warning/critical)"
          example: "info"
        source:
          $ref: "#/components/schemas/Source"
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/Suggestion'
        selectionBehavior:
          type: string
          description: " intended behavior of the suggestions. If suggestions present, value must be at-most-one"
        links: 
          type: array
          items:
            $ref: '#/components/schemas/Link'
    Source:
      type: object
      required:
        - label
      properties:
        label:
          type: string
          description: "short, human-readable label to display source of the cardâ€™s information"
          example: Human-readable source label
        url:
          type: string
          description: "optional absolute URL to load to learn more about the organization or data set"
          example: "https://example.com"
        icon:
          type: string
          description: " absolute url for an icon for the source of this card (100x100 pixel PNG without any transparent regions)"
          example: "https://example.com/img/icon-100px.png"
    Suggestion:
      type: object
      required:
        - label
      properties:
        uuid:
          type: string
          description: "unique identifier for auditing and logging suggestions"
          example: e1187895-ad57-4ff7-a1f1-ccf954b2fe46
        label:
          type: string
          description: "human-readable label to display for this suggestion"
          example: "Human-readable suggestion label"
        actions:
          type: array
          items:
            $ref: '#/components/schemas/Action'
    Action:
      type: object
      required:
        - type
        - description
      properties:
        title:
          type: string
        id:
          type: string
        type:
          type: string
          description: "type of action being performed (create/update/delete)"
          example: "create"
        description:
          type: string
          description: "human-readable description of the suggested action"
          example: "Create a prescription for Acetaminophen 250 MG"
        resource:
          type: string
          description: "FHIR resource to create/update or id of resource to delete"
          example: "MedicationRequest"
    Link:
      type: object
      required:
        - label
        - url
        - type
      properties:
        label:
          type: string
          description: "human-readable label to display"
          example: "SMART Example App"
        url:
          type: string
          description: "URL to GET when link is clicked"
        type:
          type: string
          description: "type of the given URL (absolute/smart) "
        appContext:
          type: string
          description: "additional context to share with a linked SMART app"
